K=function(){var T_TIME=0,T_VAL=1,T_SVAL=7,T_PRED=8,T_SET=9,KEPLER=0,RK89=2,PER=0,MASS=1,MA=2,ECC=3,LOP=4,SMA=13,SEMIAMP=14,TRUEANOMALY=16,JS_I_START=0,JS_I_STEP=1,JS_I_GET=2,JS_I_END=3,JS_I_ENDREACHED=-1,JS_PS_SET_PMIN=-4,JS_PS_SET_PMAX=-5,JS_PS_SETUP=-1,JS_PS_GET_FAPS_LEVELS=-2,JS_PS_GET_TOP_PERIODS=-6,JS_PS_GET_TOP_POWERS=-7,JS_PS_GET_TOP_FAPS=-8,ACTIVE=2,MINIMIZE=4,K_getDataAt=Module.cwrap("K_getDataAt","number",["number","number","number","number"]),K_getRVLine=(Module.cwrap("K_setDataAt","number",["number","number","number","number","number"]),Module.cwrap("K_getRVLine","number",["number","number","number"])),K_getPeriodogramAt=Module.cwrap("K_getPeriodogramAt","number",["number","number","number"]),K_minimizeWithTimeout=Module.cwrap("K_minimizeWithTimeout","number",["number","number"]),K_getPhasedRVLine=Module.cwrap("K_getPhasedRVLine","number",["number","number","number","number"]),K_getPhasedDataForPlanet=Module.cwrap("K_getPhasedDataForPlanet","number",["number","number","number","number"]),K_integrateForward=Module.cwrap("K_integrateForward","number",["number","number","number","number","number"]),K_alloc=(Module.cwrap("DEGRANGE","number",["number"]),Module.cwrap("RADRANGE","number",["number"]),Module.cwrap("ok_sort_small_matrix","number",["number","number"]),Module.cwrap("ok_sort_matrix","number",["number","number"]),Module.cwrap("ok_rsort_matrix","number",["number","number"]),Module.cwrap("ok_fprintf_matrix","number",["number","number","string"]),Module.cwrap("ok_fprintf_vector","number",["number","number","string"]),Module.cwrap("ok_fprintf_matrix_int","number",["number","number","string"]),Module.cwrap("ok_fprintf_vector_int","number",["number","number","string"]),Module.cwrap("ok_fprintf_buf","number",["number","number","string","number","number"]),Module.cwrap("ok_fscanf_matrix","number",["number","number"]),Module.cwrap("ok_fscanf_matrix_int","number",["number","number"]),Module.cwrap("ok_fscanf_vector","number",["number","number"]),Module.cwrap("ok_fscanf_vector_int","number",["number","number"]),Module.cwrap("ok_save_matrix","number",["number","number","string"]),Module.cwrap("ok_save_matrix_bin","number",["number","number"]),Module.cwrap("ok_save_buf","number",["number","number","string","number","number"]),Module.cwrap("ok_save_buf_bin","number",["number","number","number","number"]),Module.cwrap("ok_read_table","number",["number"]),Module.cwrap("ok_vector_resize","number",["number","number"]),Module.cwrap("ok_matrix_resize","number",["number","number","number"]),Module.cwrap("ok_vector_resize_pad","number",["number","number","number"]),Module.cwrap("ok_matrix_resize_pad","number",["number","number","number","number"]),Module.cwrap("ok_vector_int_resize","number",["number","number"]),Module.cwrap("ok_matrix_int_resize","number",["number","number","number"]),Module.cwrap("ok_matrix_copy","number",["number"]),Module.cwrap("ok_matrix_copy_sub","number",["number","number","number","number","number"]),Module.cwrap("ok_matrix_int_copy","number",["number"]),Module.cwrap("ok_vector_copy","number",["number"]),Module.cwrap("ok_vector_int_copy","number",["number"]),Module.cwrap("ok_buf_to_matrix","number",["number","number","number"]),Module.cwrap("ok_buf_col","number",["number","number","number","number"]),Module.cwrap("ok_matrix_column_range","number",["number","number","number","number"]),Module.cwrap("ok_matrix_remove_row","number",["number","number"]),Module.cwrap("ok_matrix_remove_column","number",["number","number"]),Module.cwrap("ok_matrix_int_remove_row","number",["number","number"]),Module.cwrap("ok_matrix_int_remove_column","number",["number","number"]),Module.cwrap("ok_vector_remove","number",["number","number"]),Module.cwrap("ok_vector_int_remove","number",["number","number"]),Module.cwrap("ok_matrix_fill","number",["number","number"]),Module.cwrap("ok_bootstrap_matrix","number",["number","number","number","number"]),Module.cwrap("ok_bootstrap_matrix_mean","number",["number","number","number","number","number"]),Module.cwrap("ok_matrix_filter","number",["number","number","number"]),Module.cwrap("ok_matrix_buf_filter","number",["number","number","number","number","number"]),Module.cwrap("ok_bsearch","number",["number","number","number"]),Module.cwrap("ok_average_angle","number",["number","number","number"]),Module.cwrap("ok_median_angle","number",["number","number","number"]),Module.cwrap("ok_stddev_angle","number",["number","number","number"]),Module.cwrap("ok_mad_angle","number",["number","number","number","number"]),Module.cwrap("ok_mad","number",["number","number","number"]),Module.cwrap("ok_str_copy","number",["string"]),Module.cwrap("ok_str_cat","number",["string","string"]),Module.cwrap("ok_avevar","number",["number","number","number","number"]),Module.cwrap("ok_ptr_to_matrix","number",["number","number","number"]),Module.cwrap("ok_ptr_to_vector","number",["number","number"]),Module.cwrap("ok_iptr_to_imatrix","number",["number","number","number"]),Module.cwrap("ok_iptr_to_ivector","number",["number","number"]),Module.cwrap("ok_block_to_ptr","number",["number","number"]),Module.cwrap("ok_buf_to_ptr","number",["number","number","number","number"]),Module.cwrap("ok_buf_add_to_col","number",["number","number","number","number"]),Module.cwrap("ok_vector_len","number",["number"]),Module.cwrap("ok_matrix_rows","number",["number"]),Module.cwrap("ok_matrix_cols","number",["number"]),Module.cwrap("ok_vector_block","number",["number"]),Module.cwrap("ok_matrix_block","number",["number"]),Module.cwrap("ok_resample_curve","number",["number","number","number","number","number","number","number","number","number"]),Module.cwrap("ok_file_readable","number",["number"]),Module.cwrap("ok_rivector_alloc","number",["number"]),Module.cwrap("ok_periodogram_ls","number",["number","number","number","number","number","number","number","number","number"]),Module.cwrap("ok_periodogram_boot","number",["number","number","number","number","number","number","number","number","number","number","number","number"]),Module.cwrap("ok_periodogram_full","number",["number","number","number","number","number","number","number","number"]),Module.cwrap("K_alloc","number")),K_removeData=(Module.cwrap("K_free","number",["number"]),Module.cwrap("K_clone","number",["number"]),Module.cwrap("K_cloneFlags","number",["number","number"]),Module.cwrap("K_addDataFile","number",["number","string","number"]),Module.cwrap("K_addDataTable","number",["number","number","string","number"]),Module.cwrap("K_removeData","number",["number","number"])),K_getDataName=(Module.cwrap("K_getData","number",["number","number"]),Module.cwrap("K_setData","number",["number","number","number"]),Module.cwrap("K_getDataName","string",["number","number"])),K_addDataFromSystem=Module.cwrap("K_addDataFromSystem","number",["number","string"]),K_getDataSize=(Module.cwrap("K_getDataType","number",["number","number"]),Module.cwrap("K_getDataSize","number",["number","number"])),K_addPlanet=(Module.cwrap("K_compileData","number",["number"]),Module.cwrap("K_getCompiledDataMatrix","number",["number"]),Module.cwrap("K_addPlanet","number",["number","number"])),K_removePlanet=Module.cwrap("K_removePlanet","number",["number","number"]),K_setElement=Module.cwrap("K_setElement","number",["number","number","number","number"]),K_getElement=Module.cwrap("K_getElement","number",["number","number","number"]),K_setElementFlag=(Module.cwrap("K_setElements","number",["number","number"]),Module.cwrap("K_getElements","number",["number"]),Module.cwrap("K_setElementFlag","number",["number","number","number","number"])),K_getMstar=(Module.cwrap("K_getElementFlag","number",["number","number","number"]),Module.cwrap("K_setElementStep","number",["number","number","number","number"]),Module.cwrap("K_getElementStep","number",["number","number","number"]),Module.cwrap("K_setElementRange","number",["number","number","number","number","number"]),Module.cwrap("K_getElementRange","number",["number","number","number","number","number"]),Module.cwrap("K_getAllElements","number",["number"]),Module.cwrap("K_getActivePars","number",["number"]),Module.cwrap("K_getActiveElements","number",["number"]),Module.cwrap("K_getNrPars","number",["number"]),Module.cwrap("K_setElementType","number",["number","number"]),Module.cwrap("K_getElementType","number",["number"]),Module.cwrap("K_getXYZ","number",["number"]),Module.cwrap("K_setMstar","number",["number","number"]),Module.cwrap("K_getMstar","number",["number"])),K_setEpoch=Module.cwrap("K_setEpoch","number",["number","number"]),K_getEpoch=Module.cwrap("K_getEpoch","number",["number"]),K_getChi2=Module.cwrap("K_getChi2","number",["number"]),K_getRms=(Module.cwrap("K_getChi2_nr","number",["number"]),Module.cwrap("K_getLoglik","number",["number"]),Module.cwrap("K_getRms","number",["number"])),K_getJitter=Module.cwrap("K_getJitter","number",["number"]),K_getNsets=(Module.cwrap("K_getCompiled","number",["number"]),Module.cwrap("K_getNrvs","number",["number"]),Module.cwrap("K_getNtts","number",["number"]),Module.cwrap("K_getNsets","number",["number"])),K_setIntMethod=(Module.cwrap("K_getChi2_rvs","number",["number"]),Module.cwrap("K_getChi2_tts","number",["number"]),Module.cwrap("K_getRms_tts","number",["number"]),Module.cwrap("K_setFlags","number",["number","number"]),Module.cwrap("K_getFlags","number",["number"]),Module.cwrap("K_setMinFunc","number",["number","number"]),Module.cwrap("K_getMinFunc","number",["number"]),Module.cwrap("K_setElementSteps","number",["number","number"]),Module.cwrap("K_getElementSteps","number",["number"]),Module.cwrap("K_setParSteps","number",["number","number"]),Module.cwrap("K_getParSteps","number",["number"]),Module.cwrap("K_setElementFlags","number",["number","number"]),Module.cwrap("K_getElementFlags","number",["number"]),Module.cwrap("K_setParFlags","number",["number","number"]),Module.cwrap("K_getParFlags","number",["number"]),Module.cwrap("K_setIntMethod","number",["number","number"])),K_getIntMethod=Module.cwrap("K_getIntMethod","number",["number"]),K_setIntAbsAcc=(Module.cwrap("K_setProgress","number",["number","number"]),Module.cwrap("K_getProgress","number",["number"]),Module.cwrap("K_setIntOptions","number",["number","number"]),Module.cwrap("K_getIntOptions","number",["number"]),Module.cwrap("K_setCustomModelFunction","number",["number","number"]),Module.cwrap("K_getCustomModelFunction","number",["number"]),Module.cwrap("K_setIntAbsAcc","number",["number","number"])),K_setIntRelAcc=(Module.cwrap("K_getIntAbsAcc","number",["number"]),Module.cwrap("K_setIntRelAcc","number",["number","number"])),K_getNplanets=(Module.cwrap("K_getIntRelAcc","number",["number"]),Module.cwrap("K_setIntDt","number",["number","number"]),Module.cwrap("K_getIntDt","number",["number"]),Module.cwrap("K_getNplanets","number",["number"])),K_getNdata=Module.cwrap("K_getNdata","number",["number"]),K_setPar=(Module.cwrap("K_getRange","number",["number","number","number"]),Module.cwrap("K_perturb","number",["number"]),Module.cwrap("K_setPars","number",["number","number"]),Module.cwrap("K_getPars","number",["number"]),Module.cwrap("K_setPar","number",["number","number","number"])),K_getPar=Module.cwrap("K_getPar","number",["number","number"]),K_setParFlag=Module.cwrap("K_setParFlag","number",["number","number","number"]),K_addDataFromSystem=(Module.cwrap("K_getParFlag","number",["number","number"]),Module.cwrap("K_setParStep","number",["number","number","number"]),Module.cwrap("K_getParStep","number",["number","number"]),Module.cwrap("K_setParRange","number",["number","number","number","number"]),Module.cwrap("K_getParRange","number",["number","number","number","number"]),Module.cwrap("K_save","number",["number","number"]),Module.cwrap("K_load","number",["number","number"]),Module.cwrap("K_addDataFromSystem","number",["number","string"])),K_calculate=Module.cwrap("K_calculate","number",["number"]),k=(Module.cwrap("K_minimize","number",["number","number","number","number"]),Module.cwrap("K_1dminimize","number",["number","number","number","number","number","number"]),Module.cwrap("K_integrate","number",["number","number","number","number"]),Module.cwrap("K_integrateRange","number",["number","number","number","number","number","number"]),Module.cwrap("K_integrateStellarVelocity","number",["number","number","number","number","number","number"]),Module.cwrap("K_integrateProgress","number",["number","number","number","number"]),Module.cwrap("K_print","number",["number","number"]),Module.cwrap("K_save_old","number",["number","string"]),Module.cwrap("K_setSeed","number",["number","number"]),Module.cwrap("ok_bridge_kernel_buf","number",["number","number","number"]),K_alloc()),SERIES=6,RVLINE=6,RVPLOT="#rv",PSPLOT="#ps";PSDATA=null;var NULL=null,INTMETHOD=KEPLER,currentSystem="14Her.sys",stopped=!1;MAX_PLANETS=6,MAX_ELEMENTS=5,MAX_SETS=7,EL_MIN_MAX=[[-1,4],[-3,1],[0,360],[0,.99],[0,360]],COLORS=["#007AFF","#FF3B30","#4CD964","#5856D6","#FF9500","#34AADC"],VOMAX=500;var init=function(){integrateData=null,K_removePlanet(k,-1),K_removeData(k,-1),K_setEpoch(k,0/0),K_setIntMethod(k,INTMETHOD),K_setIntRelAcc(k,1e-11),K_setIntAbsAcc(k,1e-11)},PSMIN=1,PSMAX=2e4,setPSRange=function(min,max){K_getPeriodogramAt(k,JS_PS_SET_PMIN,min),K_getPeriodogramAt(k,JS_PS_SET_PMAX,max),PSMIN=min,PSMAX=max,$("#ps-from").val(min),$("#ps-to").val(max),refreshPSPlot(),refreshShare()},refreshPSPlot=function(){if(0!=K_getNdata(k)){var plotter=$("#psplot").highcharts();if("#ps"!=PSPLOT)return plotter.series[0].hide(),void 0;plotter.series[0].show();var i,samples=K_getPeriodogramAt(k,JS_PS_SETUP,0),data=[];for(i=0;samples>i;i++)data.push([Math.log(K_getPeriodogramAt(k,i,0))/Math.LN10,K_getPeriodogramAt(k,i,1),K_getPeriodogramAt(k,i,2)]);for(plotter.series[0].setData(data,!0),i=1;3>=i;i++){var fap_z=K_getPeriodogramAt(k,JS_PS_GET_FAPS_LEVELS,i);plotter.series[i].setData([[data[0][0],fap_z],[data[data.length-1][0],fap_z]])}for(PSDATA=data,i=0;10>i;i++)$("#pstable_p"+i).html(K_getPeriodogramAt(k,JS_PS_GET_TOP_PERIODS,i).toFixed(4)),$("#pstable_power"+i).html(K_getPeriodogramAt(k,JS_PS_GET_TOP_POWERS,i).toFixed(4)),$("#pstable_fap"+i).html(K_getPeriodogramAt(k,JS_PS_GET_TOP_FAPS,i).toExponential(2))}},eps=1e-6,getFAPforPeriod=function(P){if(!PSDATA)return 0;for(var i=0;i<PSDATA.length;i++)if(Math.abs(PSDATA[i][0]-P)<eps)return PSDATA[i][2];return 0},integrateData=null,INTEGRATESERIES_OFFSET=RVLINE+1,INTEGRATE_PLOT=0,INTEGRATE_XAXIS="Time [years]",INTEGRATE_YAXIS_A="Semi-major axis [AU]",INTEGRATE_YAXIS_ECC="Eccentricity",setIntegratePlot=function(what){INTEGRATE_PLOT=what,refreshIntegratePlot()},refreshIntegratePlot=function(){var i,plotter=$("#rvplot").highcharts();if(null==integrateData)for(i=INTEGRATESERIES_OFFSET;INTEGRATESERIES_OFFSET+MAX_PLANETS>i;i++)plotter.series[i].hide(),plotter.series[i].update({showInLegend:!1}),plotter.series[i].setData(null);else{var data;for(0==INTEGRATE_PLOT?(data=integrateData.a,plotter.yAxis[0].update({title:{text:INTEGRATE_YAXIS_A}})):(data=integrateData.ecc,plotter.yAxis[0].update({title:{text:INTEGRATE_YAXIS_ECC}})),i=1;i<=K_getNplanets(k);i++)plotter.series[i+INTEGRATESERIES_OFFSET-1].show(),plotter.series[i+INTEGRATESERIES_OFFSET-1].update({showInLegend:!0}),plotter.series[i+INTEGRATESERIES_OFFSET-1].setData(data[i],!0)}plotter.redraw()},integrateForward=function(nyears){integrateData={},integrateData.a=[],integrateData.ecc=[],integrateData.years=[],console.log(nyears);var i;for(i=1;i<=K_getNplanets(k);i++)integrateData.a[i]=[],integrateData.ecc[i]=[];K_integrateForward(k,JS_I_START,nyears,-1,-1);exec(null,function(){return stepIntegration(nyears)},function(){K_integrateForward(k,JS_I_END,nyears,-1,-1),refreshIntegratePlot()},100)},stepIntegration=function(nyears){var time=K_integrateForward(k,JS_I_STEP,nyears,-1,-1);if(time==JS_I_ENDREACHED||stopped)return!0;if(0>time){var t=integrateData.years.length>0?integrateData.years[integrateData.years.length-1]:0;return alert("Probable close encounter at t = "+t+" years"),!0}var i;for(i=1;i<=K_getNplanets(k);i++)integrateData.a[i].push([time,K_integrateForward(k,JS_I_GET,nyears,i,SMA)]),integrateData.ecc[i].push([time,K_integrateForward(k,JS_I_GET,nyears,i,ECC)]);return integrateData.years.push(time),refreshIntegratePlot(),!1},PHASED_PLANET=1,RV_DEFAULT_XAXIS="Julian Days [d]",RV_PHASED_XAXIS="Phase [d] - Phased to planet ",RV_YAXIS="Radial velocity [m/s]",resetSeries=function(){for(var plotter=$("#rvplot").highcharts(),i=0;i<plotter.series.length;i++)plotter.series[i].setData(null)},setPhasedPlanet=function(n){PHASED_PLANET=n,resetSeries(),refresh()},refreshRVPlot=function(){if(0!=K_getNdata(k)){var plotter=$("#rvplot").highcharts(),nsets=K_getNsets(k);if("#rv"==RVPLOT||"#res"==RVPLOT){plotter.yAxis[0].update({title:{text:RV_YAXIS}},!1),plotter.xAxis[0].update({title:{text:RV_DEFAULT_XAXIS},min:null,max:null},!1);for(var i=0;SERIES>i;i++)if(i>=nsets)plotter.series[i].hide(),plotter.series[i].setData(null),plotter.series[i].update({showInLegend:!1});else{plotter.series[i].show(),plotter.series[i].update({showInLegend:!0}),plotter.series[i].update({name:K_getDataName(k,i)},!1);for(var data=[],size=K_getDataSize(k,i),j=0;size>j;j++)"#rv"==RVPLOT?data.push([K_getDataAt(k,i,j,T_TIME),K_getDataAt(k,i,j,T_SVAL)]):"#res"==RVPLOT&&data.push([K_getDataAt(k,i,j,T_TIME),K_getDataAt(k,i,j,T_SVAL)-K_getDataAt(k,i,j,T_PRED)]);plotter.series[i].setData(data,!1)}plotter.redraw()}else if("#phased"==RVPLOT){if(1>PHASED_PLANET||PHASED_PLANET>K_getNplanets(k))return uialert("Selected planet in phased radial velocity plot is "+PHASED_PLANET+", but there are not enough planets in the fit."),void 0;plotter.yAxis[0].update({title:{text:RV_YAXIS}},!1),plotter.xAxis[0].update({title:{text:RV_PHASED_XAXIS+PHASED_PLANET}},!1);var dataSets=[];for(i=0;SERIES>i;i++)i>=nsets?(plotter.series[i].hide(),plotter.series[i].update({showInLegend:!1})):(plotter.series[i].show(),plotter.series[i].update({showInLegend:!0}),dataSets[i]=[],plotter.series[i].update({name:K_getDataName(k,i)},!1));for(K_getPhasedDataForPlanet(k,PHASED_PLANET,-1,-1),i=0;i<K_getNdata(k);i++){var d=parseInt(K_getPhasedDataForPlanet(k,-1,i,T_SET));dataSets[d].push([K_getPhasedDataForPlanet(k,-1,i,T_TIME),K_getPhasedDataForPlanet(k,-1,i,T_VAL)])}for(i=0;nsets>i;i++)plotter.series[i].setData(dataSets[i],!1);plotter.redraw()}else if("#dynamical"==RVPLOT){for(i=0;SERIES>i;i++)plotter.series[i].hide(),plotter.series[i].update({showInLegend:!1});plotter.series[RVLINE].update({showInLegend:!1}),plotter.xAxis[0].update({title:{text:INTEGRATE_XAXIS}},!1)}}},refreshRVLine=function(){if(0!=K_getNdata(k)){var i,plotter=$("#rvplot").highcharts(),SAMP=0,rvline=[];if("#rv"==RVPLOT){if(SAMP=K_getRVLine(k,-1,2e3),console.log(SAMP),0>SAMP?($("#alert-short-period").show(),SAMP*=-1):$("#alert-short-period").hide(),SAMP>0)for(i=0;SAMP>i;i++)rvline.push([K_getRVLine(k,i,0),K_getRVLine(k,i,1)]);plotter.series[RVLINE].show(),plotter.series[RVLINE].update({showInLegend:!0}),plotter.series[RVLINE].setData(rvline,!0)}else if("#res"==RVPLOT||"#dynamical"==RVPLOT)plotter.series[RVLINE].hide(),plotter.series[RVLINE].update({showInLegend:!1});else if("#phased"==RVPLOT){if(1>PHASED_PLANET||PHASED_PLANET>K_getNplanets(k))return uialert("Selected planet in phased radial velocity plot is "+PHASED_PLANET+", but there are not enough planets in the fit."),void 0;if(SAMP=1e3,K_getPhasedRVLine(k,PHASED_PLANET,-SAMP,-1)>0)for(i=0;SAMP>i;i++)rvline.push([K_getPhasedRVLine(k,-1,i,0),K_getPhasedRVLine(k,-1,i,1)]);plotter.series[RVLINE].setData(rvline,!0),plotter.series[RVLINE].show(),plotter.series[RVLINE].update({showInLegend:!0})}}},zoom=200;zoomFactor=1;var TORAD=Math.PI/180,POINTSIZE=6,ORBITCOLOR="#cccccc",zoomInOut=function(dir){0>dir?1==zoomFactor?zoomFactor=-2:zoomFactor--:-2==zoomFactor?zoomFactor=1:zoomFactor++,refreshOrbit()},refreshOrbit=function(){var zoomFac=0>zoomFactor?-1/zoomFactor:zoomFactor,canvas=$("#orbitalplot");canvas.clearCanvas(),canvas.translateCanvas({translateX:canvas.width()/2,translateY:canvas.height()/2}),canvas.drawPolygon({fillStyle:"black",x:0,y:0,radius:POINTSIZE,sides:6,concavity:.5});for(var outside=0,i=1;i<=K_getNplanets(k);i++){var a=K_getElement(k,i,SMA)*zoom*zoomFac,e=K_getElement(k,i,ECC),p=K_getElement(k,i,LOP),b=0==e?a:Math.sqrt(a*a*(1-e*e)),f=K_getElement(k,i,TRUEANOMALY)*TORAD,r=a*(1-e*e)/(1+e*Math.cos(f)),center=-a*e;a*(1-e)>.5*zoom?outside++:canvas.rotateCanvas({x:0,y:0,rotate:-p}).drawEllipse({strokeStyle:ORBITCOLOR,x:center,y:0,width:2*a,height:2*b}).drawEllipse({fillStyle:"black",x:r*Math.cos(f),y:-r*Math.sin(f),width:POINTSIZE,height:POINTSIZE}).restoreCanvas()}canvas.restoreCanvas(),$("#zoomText").html((0>zoomFactor?-zoomFactor:(1/zoomFactor).toFixed(2))+" AU"+(outside>0?"<br>["+outside+" planet"+(outside>1?"s":"")+" outside the view]":""))},prettyValue=function(v){return v=Math.abs(v)>.01?v.toFixed(4):Math.abs(v)>.001?v.toFixed(5):Math.abs(v)>1e-4?v.toFixed(6):Math.abs(v)>1e-5?v.toFixed(7):Math.abs(v)>1e-6?v.toFixed(8):Math.abs(v)>1e-7?v.toFixed(9):0},refreshPlanetPanel=function(){for(var i=1;i<=K_getNplanets(k);i++){for(var j=PER;LOP>=j;j++){var v=prettyValue(K_getElement(k,i,j));$("#element_"+i+"_"+j).val(v),$("#elementSlider_"+i+"_"+j).val(j==PER||j==MASS?Math.log(v)/Math.LN10:v)}$("#extra_"+i).html("<label>Semi-major axis [AU]:</label>&nbsp;"+prettyValue(K_getElement(k,i,SMA))+", <label>Semiamp. [m/s]:</label>&nbsp;"+prettyValue(K_getElement(k,i,SEMIAMP)))}},refreshParamPanel=function(){for(var i=0;MAX_SETS>i;i++){var v=prettyValue(K_getPar(k,i));$("#offset_"+i).val(v),$("#offsetSlider_"+i).val(v)}},refreshStats=function(){$("#chi2").text(K_getChi2(k).toFixed(2)),$("#rms").text(K_getRms(k).toFixed(2)),$("#jitter").text(K_getJitter(k).toFixed(2)),$("#data").text(K_getNsets(k)+" sets, "+K_getNdata(k)+" data points"),$("#mstar").text(K_getMstar(k)),$("#epoch").text(K_getEpoch(k))},BASEURL=location.protocol+"//"+location.host+location.pathname,URLPARAMS=["P","M","MA","E","L"],PRECISION=7,shortenNumber=function(n){var s=n.toPrecision(PRECISION),s2=s.replace(/0*$/,"");return parseFloat(s)==parseFloat(s2)?s2:s},refreshShare=function(){var url=BASEURL+"?";url+="sys="+encodeURI(currentSystem),url+="&np="+K_getNplanets(k);var i;for(i=1;i<=K_getNplanets(k);i++)for(j=PER;LOP>=j;j++){var v=K_getElement(k,i,j);0!=v&&(url+="&"+URLPARAMS[j]+i+"="+shortenNumber(v))}for(i=0;MAX_SETS>i;i++)0!=K_getPar(k,i)&&(url+="&o"+i+"="+shortenNumber(K_getPar(k,i)));_.parameter("debug",SYSTEMIC_PARAMETERS)&&(url+="&debug=true"),url+="&im="+K_getIntMethod(k),1!=PSMIN&&(url+="&psmin="+shortenNumber(PSMIN)),2e4!=PSMAX&&(url+="&psmax="+shortenNumber(PSMAX)),$("#share").val(url),window.history.replaceState&&window.history.replaceState({},"",url)},refreshCallbacks=[],addRefreshCallback=function(cb){refreshCallbacks.push(cb)},refresh=function(what){what="undefined"!=typeof what?what:["rvplot","rvline","elements","params","stats","psplot","orbit"],(-1!=what.indexOf("rvplot")||"#rv"!=RVPLOT&&-1!=what.indexOf("rvline")||-1!=what.indexOf("elements")||-1!=what.indexOf("params")||-1!=what.indexOf("psplot"))&&K_calculate(k),(-1!=what.indexOf("rvplot")||"#rv"!=RVPLOT&&-1!=what.indexOf("rvline"))&&refreshRVPlot(),-1!=what.indexOf("rvline")&&refreshRVLine(),-1!=what.indexOf("elements")&&refreshPlanetPanel(),-1!=what.indexOf("params")&&refreshParamPanel(),-1!=what.indexOf("stats")&&refreshStats(),-1!=what.indexOf("psplot")&&refreshPSPlot(),-1!=what.indexOf("orbit")&&refreshOrbit(),refreshShare();for(var i=0;i<refreshCallbacks.length;i++)refreshCallbacks[i]()},setRVPlot=function(type){RVPLOT=type,resetSeries(),refresh()},getRVPlot=function(){return RVPLOT},disable=function(cb){$("#busy").show(400,function(){cb&&cb()})},enable=function(){$("#busy").hide(400)},exec=function(pre,fun,post,delay){stopped=!1,delay=delay||0,pre&&_.defer(pre);var f=function(){var ret=fun();ret?_.defer(function(){enable(),post&&post()}):_.delay(f,delay)};disable(function(){_.delay(f,delay)})},optimize=function(){for(var active=!1,i=1;i<=K_getNplanets(k);i++)for(var j=PER;LOP>=j;j++)$("#elementSel_"+i+"_"+j).is(":checked")?(K_setElementFlag(k,i,j,MINIMIZE+ACTIVE),active=!0):K_setElementFlag(k,i,j,ACTIVE);for(var i=0;MAX_SETS>i;i++)$("#offsetSel_"+i).is(":checked")?(K_setParFlag(k,i,MINIMIZE+ACTIVE),active=!0):K_setParFlag(k,i,ACTIVE);if(!active)return alert("You need to have at least one parameter selected (use the checkboxes next to each parameter.)"),void 0;var chi2=K_getChi2(k),delta=.01;exec(null,function(){console.log(chi2),K_minimizeWithTimeout(k,15),K_calculate(k);var chi2_2=K_getChi2(k);return console.log(chi2_2),isNaN(chi2_2)||delta>(chi2-chi2_2)/chi2||stopped?(console.log("After refresh: ",K_getChi2(k)),refresh(),console.log("After refresh: ",K_getChi2(k)),!0):(chi2=chi2_2,!1)},null,200)},stop=function(){stopped=!0},loadSys=function(sysname){if(init(),K_addDataFromSystem(k,"datafiles/"+sysname),K_getNsets(k)>MAX_SETS)return alert("Could not open "+sysname),loadSys("datafiles/14Her.sys"),void 0;for(var i=0;i<K_getNsets(k);i++)$("#offsetLabel_"+i).text(K_getDataName(k,i).replace("datafiles/","")),$("#offsetPanel_"+i).show();for(var i=K_getNsets(k);6>i;i++)$("#offsetPanel_"+i).hide();for(var i=1;MAX_PLANETS>=i;i++)$("#planet_"+i).hide();currentSystem=sysname,refresh()},addPlanet=function(period){integrateData=null,period="undefined"!=typeof period?period:100;var n=K_getNplanets(k);return n==MAX_PLANETS?(alert("Cannot add more planets."),void 0):(K_addPlanet(k,NULL),n++,K_setElement(k,n,PER,period),K_setElement(k,n,MASS,1),K_setElement(k,n,MA,0),K_setElement(k,n,ECC,0),K_setElement(k,n,LOP,0),$("#planet_"+n).show(),refresh(["rvline","elements","stats","psplot","orbit"]),void 0)},removePlanet=function(){integrateData=null;var n=K_getNplanets(k);return 0==n?(alert("No more planets to remove."),void 0):(K_removePlanet(k,n),$("#planet_"+n).hide(),refresh(["rvline","elements","stats","psplot","orbit"]),void 0)},loadFromURL=function(){K.loadSys(_.parameter("sys",SYSTEMIC_PARAMETERS));var i,v,np=+(_.parameter("np",SYSTEMIC_PARAMETERS)||0);for(i=1;np>=i;i++){addPlanet(100);for(var j=0;j<URLPARAMS.length;j++)v=+(_.parameter(URLPARAMS[j]+i,SYSTEMIC_PARAMETERS)||0),K_setElement(k,i,j,v)}for(i=0;MAX_SETS>i;i++)v=+(_.parameter("o"+i,SYSTEMIC_PARAMETERS)||0),K_setPar(k,i,v);_.parameter("psmin",SYSTEMIC_PARAMETERS)&&(PSMIN=+(_.parameter("psmin",SYSTEMIC_PARAMETERS)||1)),_.parameter("psmax",SYSTEMIC_PARAMETERS)&&(PSMAX=+(_.parameter("psmax")||2e4)),setPSRange(PSMIN,PSMAX),K_setIntMethod(k,+(_.parameter("im",SYSTEMIC_PARAMETERS)||KEPLER)),refresh()},setIntegrated=function(integ){INTMETHOD=integ?RK89:KEPLER,K_setIntMethod(k,INTMETHOD),refresh()},isIntegrated=function(){return INTMETHOD!=KEPLER},setElement=function(row,column,value,psplot){psplot="undefined"!=typeof psplot?psplot:!0,K_setElement(k,row,column,value),refresh(["rvline","elements","orbit","stats",psplot?"psplot":""])},setParam=function(row,value,psplot){psplot="undefined"!=typeof psplot?psplot:!0,K_setPar(k,row,value),refresh(["rvplot","params","stats",psplot?"psplot":""])},timeFunction=function(f){var start=(new Date).getTime();return f(),(new Date).getTime()-start},benchmark=function(){var reps=5;return timeFunction(function(){for(var i=0;reps>i;i++)K_getPeriodogramAt(k,-1,0)})};return{init:init,refresh:refresh,loadSys:loadSys,optimize:optimize,setIntegrated:setIntegrated,isIntegrated:isIntegrated,setElement:setElement,setParam:setParam,addPlanet:addPlanet,removePlanet:removePlanet,setRVPlot:setRVPlot,getRVPlot:getRVPlot,zoomInOut:zoomInOut,getFAPforPeriod:getFAPforPeriod,benchmark:benchmark,loadFromURL:loadFromURL,stop:stop,addRefreshCallback:addRefreshCallback,setPhasedPlanet:setPhasedPlanet,integrateForward:integrateForward,setIntegratePlot:setIntegratePlot,resetSeries:resetSeries,setPSRange:setPSRange,k:function(){return k},getNplanets:function(){return K_getNplanets(k)}}}();